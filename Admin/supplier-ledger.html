<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supplier Ledger - Onyx Pharma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #f85606; --bg: #eff0f5; --card: #ffffff;
            --text: #212121; --dim: #757575; --border: #ced4da;
            --danger: #d32f2f; --success: #2e7d32; --orange-light: #fff1eb;
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Inter', sans-serif; }
        body { background: var(--bg); color: var(--text); padding: 15px; }

        .container { max-width: 700px; margin: 0 auto; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .header h2 { font-size: 24px; font-weight: 800; color: var(--text); border-left: 6px solid var(--primary); padding-left: 15px; }

        /* Summary Stats */
        .summary-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .stat-box { background: #fff; padding: 15px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }
        .stat-box span { font-size: 11px; text-transform: uppercase; color: var(--dim); font-weight: 700; }
        .stat-box b { display: block; font-size: 18px; margin-top: 5px; }

        /* Search Bar */
        .search-wrapper { position: relative; margin-bottom: 20px; }
        .search-wrapper i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--dim); }
        .search-wrapper input { width: 100%; padding: 15px 15px 15px 45px; border: 1px solid var(--border); border-radius: 12px; outline: none; font-size: 16px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }

        /* Supplier Card */
        .sup-card { background: var(--card); border-radius: 16px; padding: 18px; margin-bottom: 12px; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; transition: 0.3s; }
        .sup-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .sup-info b { font-size: 18px; color: var(--text); display: block; }
        .sup-info span { font-size: 13px; color: var(--dim); }

        .sup-balance { text-align: right; }
        .sup-balance .amt { font-size: 20px; font-weight: 800; color: var(--danger); display: block; }
        .sup-balance .lbl { font-size: 10px; text-transform: uppercase; color: var(--dim); font-weight: 700; }

        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn { border: none; padding: 12px; border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-details { background: var(--orange-light); color: var(--primary); }
        .btn-pay { background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(248, 86, 6, 0.2); }

        /* Bottom Sheet */
        .sheet-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; backdrop-filter: blur(4px); }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #fff; border-radius: 24px 24px 0 0; z-index: 2001; transform: translateY(100%); transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-height: 85vh; display: flex; flex-direction: column; }
        .bottom-sheet.active { transform: translateY(0); }
        .sheet-header { padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .sheet-body { flex: 1; overflow-y: auto; padding: 15px; background: #fafafa; }

        /* Transaction Item */
        .tran-card { background: #fff; padding: 15px; border-radius: 12px; margin-bottom: 10px; border: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .tran-card.pay { border-left: 5px solid var(--success); }
        .tran-card.pur { border-left: 5px solid var(--danger); }
        .tran-desc b { font-size: 14px; display: block; }
        .tran-desc small { font-size: 12px; color: var(--dim); }
        .tran-val { text-align: right; }
        .tran-val .price { font-weight: 800; font-size: 15px; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; padding: 20px; }
        .modal-box { background: #fff; width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; }
        .modal-box h3 { margin-bottom: 20px; color: var(--primary); }
        .modal-box input, .modal-box select { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 15px; outline: none; }

        .empty-state { text-align: center; padding: 50px 20px; color: var(--dim); }
        .empty-state i { font-size: 40px; margin-bottom: 10px; opacity: 0.3; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>Supplier Ledger</h2>
        <button onclick="window.print()" style="background:none; border:none; color:var(--dim); cursor:pointer;"><i class="fa-solid fa-print"></i></button>
    </div>

    <div class="summary-row">
        <div class="stat-box">
            <span>Total Payable</span>
            <b id="totalPayAmt" style="color:var(--danger)">৳0</b>
        </div>
        <div class="stat-box">
            <span>Total Paid</span>
            <b id="totalPaidAmt" style="color:var(--success)">৳0</b>
        </div>
    </div>

    <div class="search-wrapper">
        <i class="fa-solid fa-search"></i>
        <input type="text" id="searchInp" placeholder="Search by name or phone..." oninput="doSearch()">
    </div>

    <div id="listDisplay">
        <div class="empty-state"><i class="fa-solid fa-folder-open"></i><br>Loading data...</div>
    </div>
</div>

<div class="sheet-overlay" id="sheetOverlay" onclick="closeSheet()"></div>
<div class="bottom-sheet" id="detailSheet">
    <div class="sheet-header">
        <div>
            <h3 id="sheetSupName" style="color: var(--primary);">Supplier Name</h3>
            <span id="sheetSupBalance" style="font-size: 14px; font-weight: 700; color: var(--danger);">Balance: ৳0</span>
        </div>
        <i class="fa-solid fa-times-circle" style="font-size: 24px; cursor: pointer; color: #ccc;" onclick="closeSheet()"></i>
    </div>
    <div class="sheet-body" id="sheetData"></div>
</div>

<div class="modal" id="payModal">
    <div class="modal-box">
        <h3>Add Payment</h3>
        <p id="payToName" style="font-size:13px; color:var(--dim); margin-bottom:10px;">Supplier: -</p>
        <label style="font-size:12px; font-weight:700;">PAYMENT AMOUNT</label>
        <input type="number" id="amtInp" placeholder="৳ 0.00">
        
        <label style="font-size:12px; font-weight:700;">METHOD</label>
        <select id="methodInp">
            <option>Cash</option>
            <option>Bank Transfer</option>
            <option>bKash</option>
            <option>Nagad</option>
        </select>

        <button class="btn btn-pay" style="width: 100%;" id="savePayBtn" onclick="savePay()">Confirm Payment</button>
        <button onclick="closePayModal()" style="width: 100%; border: none; background: none; margin-top: 15px; color: var(--dim); cursor: pointer;">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD1mn9MR9hyZ36Ce1lnGyJYmL6AHopScTA",
        databaseURL: "https://social-media-5e6c8-default-rtdb.firebaseio.com",
        projectId: "social-media-5e6c8",
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let data = { suppliers: [], orders: [], payments: [] };
    let activeSup = {};

    // Sync Data
    onValue(ref(db, 'purchase_orders'), (s) => { data.orders = s.exists() ? Object.values(s.val()) : []; render(); });
    onValue(ref(db, 'supplier_payments'), (s) => { data.payments = s.exists() ? Object.values(s.val()) : []; render(); });
    onValue(ref(db, 'suppliers'), (s) => { 
        data.suppliers = []; 
        if(s.exists()){
            s.forEach(c => { data.suppliers.push({id: c.key, ...c.val()}) }); 
        }
        render(); 
    });

    function render() {
        const list = document.getElementById('listDisplay');
        if(data.suppliers.length === 0) {
            list.innerHTML = `<div class="empty-state"><i class="fa-solid fa-user-slash"></i><br>No suppliers found</div>`;
            return;
        }

        list.innerHTML = '';
        let totalP = 0, totalPaid = 0;
        
        data.suppliers.forEach(sup => {
            const purAmt = data.orders.filter(o => o.supplierId === sup.id).reduce((s, o) => s + (parseFloat(o.totalPayable) || 0), 0);
            const paidAmt = data.payments.filter(p => p.supplierId === sup.id).reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
            const bal = purAmt - paidAmt;

            totalP += purAmt;
            totalPaid += paidAmt;

            list.innerHTML += `
                <div class="sup-card" data-name="${sup.company.toUpperCase()}">
                    <div class="sup-top">
                        <div class="sup-info">
                            <b>${sup.company}</b>
                            <span><i class="fa-solid fa-phone"></i> ${sup.phone || 'No Phone'}</span>
                        </div>
                        <div class="sup-balance">
                            <span class="lbl">Balance Due</span>
                            <span class="amt">৳${bal.toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-details" onclick="openSheet('${sup.id}', '${sup.company}', ${bal})"><i class="fa-solid fa-clock-history"></i> Details</button>
                        <button class="btn btn-pay" onclick="openPay('${sup.id}', '${sup.company}', ${bal})"><i class="fa-solid fa-money-bill-wave"></i> Pay</button>
                    </div>
                </div>
            `;
        });

        document.getElementById('totalPayAmt').innerText = "৳" + totalP.toLocaleString();
        document.getElementById('totalPaidAmt').innerText = "৳" + totalPaid.toLocaleString();
    }

    // Details Handler
    window.openSheet = (id, name, currentBal) => {
        document.getElementById('sheetSupName').innerText = name;
        document.getElementById('sheetSupBalance').innerText = "Balance: ৳" + currentBal.toLocaleString();
        const body = document.getElementById('sheetData');
        body.innerHTML = '';

        let logs = [
            ...data.orders.filter(o => o.supplierId === id).map(o => ({ date: o.date, label: 'Purchase #'+o.poId, amt: o.totalPayable, type: 'pur', ts: new Date(o.date).getTime() })),
            ...data.payments.filter(p => p.supplierId === id).map(p => ({ date: p.date, label: 'Payment ('+p.method+')', amt: p.amount, type: 'pay', ts: p.timestamp }))
        ].sort((a,b) => b.ts - a.ts);

        if(logs.length === 0) {
            body.innerHTML = `<div style="text-align:center; padding:30px; color:#ccc;">No transactions yet</div>`;
        }

        logs.forEach(log => {
            body.innerHTML += `
                <div class="tran-card ${log.type}">
                    <div class="tran-desc">
                        <b>${log.label}</b>
                        <small>${log.date}</small>
                    </div>
                    <div class="tran-val">
                        <span class="price" style="color:${log.type==='pur'?'var(--danger)':'var(--success)'}">
                            ${log.type==='pur'?'+':'-'} ৳${parseFloat(log.amt).toLocaleString()}
                        </span>
                    </div>
                </div>
            `;
        });

        document.getElementById('sheetOverlay').style.display = 'block';
        setTimeout(() => document.getElementById('detailSheet').classList.add('active'), 10);
    };

    window.closeSheet = () => {
        document.getElementById('detailSheet').classList.remove('active');
        setTimeout(() => document.getElementById('sheetOverlay').style.display = 'none', 400);
    };

    // Payment Logic
    window.openPay = (id, name, bal) => {
        activeSup = { id, name };
        document.getElementById('payToName').innerText = "Supplier: " + name;
        document.getElementById('amtInp').value = bal > 0 ? bal : '';
        document.getElementById('payModal').style.display = 'flex';
    };

    window.closePayModal = () => document.getElementById('payModal').style.display = 'none';

    window.savePay = async () => {
        const val = parseFloat(document.getElementById('amtInp').value);
        if(!val || val <= 0) return alert("Please enter a valid amount");

        const btn = document.getElementById('savePayBtn');
        btn.disabled = true;
        btn.innerText = "Processing...";

        try {
            const payRef = push(ref(db, 'supplier_payments'));
            await set(payRef, {
                supplierId: activeSup.id,
                supplierName: activeSup.name,
                amount: val,
                method: document.getElementById('methodInp').value,
                date: new Date().toISOString().split('T')[0],
                timestamp: Date.now()
            });

            alert("Payment recorded successfully!");
            closePayModal();
        } catch (e) {
            alert("Error: " + e.message);
        } finally {
            btn.disabled = false;
            btn.innerText = "Confirm Payment";
        }
    };

    window.doSearch = () => {
        const query = document.getElementById('searchInp').value.toUpperCase();
        document.querySelectorAll('.sup-card').forEach(c => {
            c.style.display = c.getAttribute('data-name').includes(query) ? '' : 'none';
        });
    };
</script>
</body>
</html>